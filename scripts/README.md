# Metrics Update Scripts

This directory contains scripts for updating the stock analysis HTML with latest financial metrics.

## Scripts Overview

### `final_update.py` â­ RECOMMENDED
**Main script that updates HTML with metrics from `data/calculated_metrics.json`**

Features:
- Rebuilds the Comprehensive Metrics Comparison table with correct values
- Applies intelligent highlighting (ðŸ”¥, ðŸ’ª, ðŸ’°, âœ…) based on actual metrics
- Updates Key Investment Metrics sections for all three companies
- Updates Market Overview cards
- Updates timestamp

**Usage:**
```bash
python3 scripts/final_update.py
```

**Requirements:**
- `data/calculated_metrics.json` must exist (generated by `calculate_live_metrics.py`)
- HTML file: `equity-analysis.html` in project root

---

### `calculate_live_metrics.py`
Calculates comprehensive metrics from `data/latest_data.json`

Features:
- Loads base data from latest fetch
- Calculates derived metrics (P/S, P/B, ROE, ROA, margins, etc.)
- Adds estimates for metrics not in raw data (beta, institutional ownership, etc.)
- Saves to `data/calculated_metrics.json`

**Usage:**
```bash
python3 scripts/calculate_live_metrics.py
```

---

### `update_financials.py`
Fetches live data from Yahoo Finance API

Features:
- Fetches basic financial data for all three companies
- Handles rate limits with retry logic
- Falls back to chart API if primary API fails
- Saves to `data/latest_data.json`

**Usage:**
```bash
python3 scripts/update_financials.py
```

**Note:** May encounter rate limiting from Yahoo Finance. If this happens, use cached data with `final_update.py`.

---

### `fetch_live_metrics.py`
Alternative data fetcher with more comprehensive metrics

Features:
- Fetches detailed metrics directly from yfinance
- Includes profitability ratios, growth metrics, balance sheet
- Prints summary to console

**Usage:**
```bash
python3 scripts/fetch_live_metrics.py
```

**Note:** This script doesn't save to files - use for testing/debugging only.

---

## Typical Workflow

### Option 1: Full Update (if APIs working)
```bash
# 1. Fetch latest data
python3 scripts/update_financials.py

# 2. Calculate comprehensive metrics
python3 scripts/calculate_live_metrics.py

# 3. Update HTML
python3 scripts/final_update.py
```

### Option 2: Quick Update (using cached data) â­
```bash
# Just update HTML with existing calculated metrics
python3 scripts/final_update.py
```

This is recommended when Yahoo Finance APIs are rate-limited.

---

## Automated Updates

### GitHub Actions Workflow

The workflow `.github/workflows/update-data.yml` runs automatically:
- **Schedule:** Daily at 4:30 PM HKT (8:30 AM UTC) Monday-Friday
- **Trigger:** Manual trigger available via GitHub Actions tab

**Workflow steps:**
1. Fetches data using `update_financials.py`
2. Calculates metrics using `calculate_live_metrics.py`
3. Updates HTML using `final_update.py`
4. Commits changes to repository
5. Triggers GitHub Pages deployment

**To run manually:**
1. Go to GitHub repository â†’ Actions tab
2. Select "Update Stock Analysis Data" workflow
3. Click "Run workflow" â†’ Run workflow

---

## Data Files

### `data/latest_data.json`
Raw data fetched from Yahoo Finance.
Contains basic metrics like:
- Current price
- Market cap
- P/E ratio
- Revenue
- Net income
- Gross/operating margins
- Cash and debt

### `data/calculated_metrics.json`
Comprehensive metrics calculated from `latest_data.json`.
Contains:
- All raw metrics from latest_data.json
- Calculated ratios (P/S, P/B, EV/EBITDA)
- Profitability metrics (ROE, ROA, ROIC)
- Growth metrics
- Balance sheet metrics
- Estimates for missing data

---

## Troubleshooting

### Rate Limiting Issues

If you see "Too Many Requests" errors:
1. **Use cached data:** Run `python3 scripts/final_update.py` directly
2. **Wait:** Try again in 1-2 hours
3. **Manual fetch:** Use alternative data sources

### HTML Not Updating

Check:
1. `data/calculated_metrics.json` exists and has valid data
2. `equity-analysis.html` exists in project root
3. Run script in project root directory (not in scripts/)

### Incorrect Values in Comparison Table

The comparison table may show highlighting issues if:
- Values have inline styles from previous updates
- Solution: Run `final_update.py` which rebuilds the entire table

---

## Metrics Highlighting Logic

The comparison table uses these highlighting rules:

| Category | Rule | Emoji |
|----------|-------|--------|
| Valuation (P/E, PEG, EV/EBITDA) | Lowest value | ðŸ”¥ |
| Growth (Revenue, Earnings) | Highest value | ðŸ“ˆ |
| Profitability (ROE, ROA, margins) | Highest value | ðŸ’ª |
| Cash | > $40B | ðŸ’° |
| Debt/Equity | < 0.20 | âœ… |
| Current Ratio | > 2.0 | âœ… |

---

## Adding New Metrics

To add a new metric to the comparison table:

1. Add the metric to `data/calculated_metrics.json` (or calculate in `calculate_live_metrics.py`)
2. Add the metric to the `rows` list in `final_update.py`:
   ```python
   rows = [
       # ... existing rows ...
       ('New Metric', alb['new_metric'], xia['new_metric'], mei['new_metric'], 'highlight_type'),
   ]
   ```
3. Specify the appropriate `highlight_type`:
   - `'lower_better'` for valuation metrics
   - `'higher_better'` for growth/profitability
   - `'cash_positive'` for cash metrics
   - `'debt_low'` for debt metrics
   - `'current_ratio_high'` for current ratio
   - `'none'` for no highlighting

---

## License

These scripts are part of the stock-master project.

## Unified Runner (V1)

Use `run_update.py` as the main entrypoint:

```bash
python scripts/run_update.py
python scripts/run_update.py --stocks-only
python scripts/run_update.py --news-only
```

## Provider Layer

Provider implementations are in `scripts/providers/`:

- `akshare_provider.py`
- `yfinance_provider.py`
- `finnhub_provider.py`
- `alpha_vantage_provider.py`
- `registry.py`

Configuration lives in `config/data_sources.yaml`.

## Quality Gate

Run quality checks explicitly:

```bash
python scripts/quality/check_data_quality.py
```

## Deprecated Scripts

These scripts are legacy and kept only for compatibility:

- `calculate_live_metrics.py`
- `update_financials.py`
- `fetch_prices_hybrid.py`
- `multi_source_fetcher.py`

Prefer `run_update.py` for new workflows.
